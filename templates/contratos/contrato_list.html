{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Contratos - Gestao de Contratos{% endblock %}

{% block extra_css %}
<style>
    .progress {
        height: 8px;
        border-radius: 4px;
    }
    .status-badge {
        font-size: 0.75rem;
        padding: 0.35em 0.65em;
    }
    .contrato-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .contrato-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .card-reajuste {
        border-left: 4px solid #ffc107;
    }
    .card-reajuste .badge-atraso {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.6; }
    }
    /* Selecao de contratos */
    .contrato-selecionado {
        background-color: #e7f3ff !important;
    }
    .acoes-lote {
        position: sticky;
        bottom: 0;
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        border-top: 2px solid #dee2e6;
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 8px;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
    }
    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }
    .toast-notification {
        min-width: 300px;
        padding: 15px 20px;
        margin-bottom: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        animation: slideIn 0.3s ease-out;
    }
    .toast-notification.success {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
    }
    .toast-notification.error {
        background: linear-gradient(135deg, #dc3545, #e74c3c);
        color: white;
    }
    .toast-notification i {
        font-size: 1.2rem;
        margin-right: 12px;
    }
    .toast-notification .toast-close {
        margin-left: auto;
        cursor: pointer;
        opacity: 0.7;
    }
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Toast Container -->
<div id="toastContainer" class="toast-container"></div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-file-contract"></i> Gerenciar Contratos
                </h4>
                <div>
                    <button type="button" class="btn btn-success me-2" id="btnGerarLote" style="display: none;" onclick="abrirModalGerarLote()">
                        <i class="fas fa-barcode"></i> Gerar Boletos (<span id="qtdSelecionados">0</span>)
                    </button>
                    <a href="{% url 'contratos:criar' %}" class="btn btn-light">
                        <i class="fas fa-plus"></i> Novo Contrato
                    </a>
                </div>
            </div>
            <div class="card-body">
                <!-- Barra de Busca e Filtros -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <form method="get" class="d-flex">
                            <input type="text" name="search" class="form-control me-2"
                                   placeholder="Buscar por numero, comprador, imovel..."
                                   value="{{ search }}">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                            </button>
                            {% if search %}
                                <a href="{% url 'contratos:listar' %}" class="btn btn-secondary ms-2">
                                    <i class="fas fa-times"></i>
                                </a>
                            {% endif %}
                        </form>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" onchange="window.location.href='?status=' + this.value + '{% if search %}&search={{ search }}{% endif %}{% if imobiliaria_filter %}&imobiliaria={{ imobiliaria_filter }}{% endif %}'">
                            <option value="">Todos os Status</option>
                            {% for status_val, status_label in status_choices %}
                                <option value="{{ status_val }}" {% if status_filter == status_val %}selected{% endif %}>
                                    {{ status_label }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" onchange="window.location.href='?imobiliaria=' + this.value + '{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}'">
                            <option value="">Todas as Imobiliarias</option>
                            {% for imob in imobiliarias %}
                                <option value="{{ imob.id }}" {% if imobiliaria_filter == imob.id|stringformat:"s" %}selected{% endif %}>
                                    {{ imob.nome }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 text-end">
                        <div class="badge bg-info text-dark fs-6 me-1">
                            <i class="fas fa-file-contract"></i> Total: {{ total_contratos }}
                        </div>
                        <div class="badge bg-success fs-6 me-1">
                            <i class="fas fa-check-circle"></i> Ativos: {{ contratos_ativos }}
                        </div>
                        <div class="badge bg-primary fs-6">
                            <i class="fas fa-flag-checkered"></i> Quitados: {{ contratos_quitados }}
                        </div>
                    </div>
                </div>

                <!-- Card de Contratos que Precisam de Reajuste -->
                {% if contratos_reajuste %}
                <div class="card card-reajuste mb-4">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-sync-alt"></i> Contratos que Precisam de Reajuste
                            <span class="badge bg-danger badge-atraso ms-2">{{ contratos_reajuste|length }}</span>
                        </h5>
                        <a href="{% url 'contratos:indices_listar' %}" class="btn btn-sm btn-outline-dark">
                            <i class="fas fa-chart-line"></i> Ver Indices
                        </a>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Contrato</th>
                                        <th>Comprador</th>
                                        <th>Tipo Correcao</th>
                                        <th>Ultimo Reajuste</th>
                                        <th>Data Prevista</th>
                                        <th>Atraso</th>
                                        <th class="text-center">Acao</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in contratos_reajuste %}
                                    <tr>
                                        <td>
                                            <strong>{{ item.contrato.numero_contrato }}</strong>
                                        </td>
                                        <td>{{ item.contrato.comprador.nome|truncatechars:25 }}</td>
                                        <td>
                                            <span class="badge {% if item.contrato.tipo_correcao == 'IPCA' %}bg-primary{% elif item.contrato.tipo_correcao == 'IGPM' %}bg-success{% else %}bg-info{% endif %}">
                                                {{ item.contrato.tipo_correcao }}
                                            </span>
                                        </td>
                                        <td>
                                            {% if item.data_ultimo_reajuste %}
                                                {{ item.data_ultimo_reajuste|date:"d/m/Y" }}
                                            {% else %}
                                                <span class="text-muted">Nunca</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ item.proxima_data_reajuste|date:"d/m/Y" }}</td>
                                        <td>
                                            {% if item.meses_atraso == 0 %}
                                                <span class="badge bg-warning text-dark">Este mes</span>
                                            {% elif item.meses_atraso == 1 %}
                                                <span class="badge bg-danger">1 mes</span>
                                            {% else %}
                                                <span class="badge bg-danger">{{ item.meses_atraso }} meses</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <a href="{% url 'contratos:detalhe' item.contrato.pk %}" class="btn btn-sm btn-outline-primary" title="Ver Detalhes">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if contratos %}
                    <div class="table-responsive">
                        <table class="table table-hover align-middle" id="tabelaContratos">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-center" style="width: 40px;">
                                        <input type="checkbox" class="form-check-input" id="selecionarTodos" onchange="toggleSelecionarTodos(this)" title="Selecionar todos">
                                    </th>
                                    <th>Contrato</th>
                                    <th>Comprador</th>
                                    <th>Imovel</th>
                                    <th>Valor Total</th>
                                    <th>Parcelas</th>
                                    <th>Progresso</th>
                                    <th>Status</th>
                                    <th class="text-center">Acoes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for contrato in contratos %}
                                <tr class="contrato-row" data-contrato-id="{{ contrato.pk }}" data-contrato-numero="{{ contrato.numero_contrato }}" data-contrato-status="{{ contrato.status }}">
                                    <td class="text-center">
                                        {% if contrato.status == 'ATIVO' %}
                                        <input type="checkbox" class="form-check-input contrato-checkbox" value="{{ contrato.pk }}" onchange="atualizarSelecao()">
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ contrato.numero_contrato }}</strong>
                                        <br>
                                        <small class="text-muted">
                                            {{ contrato.data_contrato|date:"d/m/Y" }}
                                        </small>
                                    </td>
                                    <td>
                                        <i class="fas fa-user text-primary"></i>
                                        {{ contrato.comprador.nome }}
                                    </td>
                                    <td>
                                        <i class="fas fa-home text-success"></i>
                                        {{ contrato.imovel.identificacao }}
                                        <br>
                                        <small class="text-muted">{{ contrato.imovel.loteamento }}</small>
                                    </td>
                                    <td>
                                        <strong>R$ {{ contrato.valor_total|floatformat:2 }}</strong>
                                        {% if contrato.valor_entrada > 0 %}
                                        <br>
                                        <small class="text-muted">Entrada: R$ {{ contrato.valor_entrada|floatformat:2 }}</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary">
                                            {{ contrato.numero_parcelas }}x
                                        </span>
                                        <br>
                                        <small class="text-muted">
                                            R$ {{ contrato.valor_parcela_original|floatformat:2 }}
                                        </small>
                                    </td>
                                    <td style="min-width: 120px;">
                                        {% with progresso=contrato.calcular_progresso %}
                                        <div class="progress mb-1">
                                            <div class="progress-bar {% if progresso >= 100 %}bg-success{% elif progresso >= 50 %}bg-info{% else %}bg-warning{% endif %}"
                                                 role="progressbar"
                                                 style="width: {{ progresso }}%"
                                                 aria-valuenow="{{ progresso }}"
                                                 aria-valuemin="0"
                                                 aria-valuemax="100">
                                            </div>
                                        </div>
                                        <small class="text-muted">{{ progresso|floatformat:1 }}% pago</small>
                                        {% endwith %}
                                    </td>
                                    <td>
                                        <span class="badge status-badge {% if contrato.status == 'ATIVO' %}bg-success{% elif contrato.status == 'QUITADO' %}bg-primary{% elif contrato.status == 'CANCELADO' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                                            {{ contrato.get_status_display }}
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'contratos:detalhe' contrato.pk %}"
                                               class="btn btn-outline-info"
                                               title="Ver Detalhes">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'contratos:editar' contrato.pk %}"
                                               class="btn btn-outline-primary"
                                               title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            {% if contrato.status != 'CANCELADO' %}
                                            <button type="button"
                                                    class="btn btn-outline-danger"
                                                    title="Cancelar Contrato"
                                                    onclick="confirmarCancelamento('{{ contrato.numero_contrato }}', '{% url 'contratos:excluir' contrato.pk %}')">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginacao -->
                    {% if is_paginated %}
                        <nav aria-label="Navegacao de paginas">
                            <ul class="pagination justify-content-center">
                                {% if page_obj.has_previous %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                                            <i class="fas fa-chevron-left"></i>
                                        </a>
                                    </li>
                                {% endif %}

                                <li class="page-item active">
                                    <span class="page-link">
                                        {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                                    </span>
                                </li>

                                {% if page_obj.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search %}&search={{ search }}{% endif %}{% if status_filter %}&status={{ status_filter }}{% endif %}">
                                            <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                {% endif %}
                            </ul>
                        </nav>
                    {% endif %}
                {% else %}
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle fa-3x mb-3"></i>
                        <h5>Nenhum contrato encontrado</h5>
                        <p>
                            {% if search %}
                                Sua busca por "{{ search }}" nao retornou resultados.
                            {% else %}
                                Comece cadastrando um novo contrato.
                            {% endif %}
                        </p>
                        <a href="{% url 'contratos:criar' %}" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Cadastrar Primeiro Contrato
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmacao de Cancelamento -->
<div class="modal fade" id="modalCancelamento" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Confirmar Cancelamento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja cancelar o contrato <strong id="nomeContrato"></strong>?</p>
                <p class="text-warning">
                    <i class="fas fa-info-circle"></i> O cancelamento nao pode ser desfeito e o imovel sera liberado para novas vendas.
                </p>
                <p class="text-danger">
                    <i class="fas fa-exclamation-circle"></i> Se houver parcelas pagas, o cancelamento nao sera permitido.
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Voltar
                </button>
                <form id="formCancelamento" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-ban"></i> Cancelar Contrato
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Geracao em Lote -->
<div class="modal fade" id="modalGerarLote" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-barcode"></i> Gerar Boletos em Lote
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Regras de geracao:</strong>
                    <ul class="mb-0 mt-2">
                        <li>Contratos com indice <strong>FIXO</strong>: Todas as parcelas podem ser geradas</li>
                        <li>Demais indices: Apenas parcelas do ciclo atual (ate reajuste pendente)</li>
                        <li>Parcelas ja com boleto serao ignoradas</li>
                    </ul>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Quantidade de Boletos por Contrato</label>
                    <div class="input-group" style="max-width: 300px;">
                        <button type="button" class="btn btn-outline-secondary" onclick="setQtdLote(1)">1</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="setQtdLote(6)">6</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="setQtdLote(12)">12</button>
                        <input type="number" class="form-control text-center" id="qtdBoletosLote" min="1" max="120" value="1">
                    </div>
                    <small class="text-muted">Maximo de boletos a gerar por contrato (respeitando restricoes de reajuste)</small>
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">Contratos Selecionados</label>
                    <div id="listaContratosSelecionados" class="border rounded p-2" style="max-height: 250px; overflow-y: auto;">
                        <!-- Lista sera preenchida via JS -->
                    </div>
                </div>

                <div id="resultadoGeracaoLote" class="d-none">
                    <h6 class="mb-2">Resultado da Geracao</h6>
                    <div id="resultadoConteudo" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-success" id="btnConfirmarGerarLote" onclick="confirmarGerarLote()">
                    <i class="fas fa-barcode"></i> Gerar Boletos
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function confirmarCancelamento(numero, url) {
        document.getElementById('nomeContrato').textContent = numero;
        document.getElementById('formCancelamento').action = url;
        new bootstrap.Modal(document.getElementById('modalCancelamento')).show();
    }

    // ============ FUNCOES DE TOAST ============

    function showToast(message, type, duration) {
        type = type || 'success';
        duration = duration || 4000;
        var container = document.getElementById('toastContainer');
        var toast = document.createElement('div');
        toast.className = 'toast-notification ' + type;

        var icon = type === 'success' ? 'fa-check-circle' :
                   type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';

        toast.innerHTML = '<i class="fas ' + icon + '"></i>' +
                          '<span>' + message + '</span>' +
                          '<span class="toast-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></span>';

        container.appendChild(toast);

        setTimeout(function() {
            toast.style.animation = 'slideOut 0.3s ease-out forwards';
            setTimeout(function() { toast.remove(); }, 300);
        }, duration);
    }

    // ============ FUNCOES DE SELECAO ============

    function toggleSelecionarTodos(checkbox) {
        var checkboxes = document.querySelectorAll('.contrato-checkbox');
        checkboxes.forEach(function(cb) {
            cb.checked = checkbox.checked;
            var row = cb.closest('tr');
            if (row) {
                if (cb.checked) {
                    row.classList.add('contrato-selecionado');
                } else {
                    row.classList.remove('contrato-selecionado');
                }
            }
        });
        atualizarSelecao();
    }

    function atualizarSelecao() {
        var checkboxes = document.querySelectorAll('.contrato-checkbox:checked');
        var qtd = checkboxes.length;
        var btnGerar = document.getElementById('btnGerarLote');
        var qtdSpan = document.getElementById('qtdSelecionados');

        qtdSpan.textContent = qtd;

        if (qtd > 0) {
            btnGerar.style.display = 'inline-block';
        } else {
            btnGerar.style.display = 'none';
        }

        // Atualizar visual das linhas
        document.querySelectorAll('.contrato-checkbox').forEach(function(cb) {
            var row = cb.closest('tr');
            if (row) {
                if (cb.checked) {
                    row.classList.add('contrato-selecionado');
                } else {
                    row.classList.remove('contrato-selecionado');
                }
            }
        });
    }

    // ============ FUNCOES DE GERACAO EM LOTE ============

    function setQtdLote(qtd) {
        document.getElementById('qtdBoletosLote').value = qtd;
    }

    function abrirModalGerarLote() {
        var checkboxes = document.querySelectorAll('.contrato-checkbox:checked');
        if (checkboxes.length === 0) {
            alert('Selecione pelo menos um contrato');
            return;
        }

        // Preencher lista de contratos selecionados
        var lista = document.getElementById('listaContratosSelecionados');
        var html = '<table class="table table-sm mb-0"><thead class="table-light"><tr><th>Contrato</th><th>Status</th></tr></thead><tbody>';

        checkboxes.forEach(function(cb) {
            var row = cb.closest('tr');
            var numero = row.getAttribute('data-contrato-numero');
            html += '<tr><td><strong>' + numero + '</strong></td><td><span class="badge bg-success">Ativo</span></td></tr>';
        });

        html += '</tbody></table>';
        lista.innerHTML = html;

        // Resetar resultado
        document.getElementById('resultadoGeracaoLote').classList.add('d-none');
        document.getElementById('btnConfirmarGerarLote').disabled = false;
        document.getElementById('btnConfirmarGerarLote').innerHTML = '<i class="fas fa-barcode"></i> Gerar Boletos';

        new bootstrap.Modal(document.getElementById('modalGerarLote')).show();
    }

    function confirmarGerarLote() {
        var checkboxes = document.querySelectorAll('.contrato-checkbox:checked');
        var contratoIds = Array.from(checkboxes).map(function(cb) { return parseInt(cb.value); });
        var quantidade = parseInt(document.getElementById('qtdBoletosLote').value) || 1;

        if (contratoIds.length === 0) {
            alert('Nenhum contrato selecionado');
            return;
        }

        var btn = document.getElementById('btnConfirmarGerarLote');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando boletos...';

        fetch('/financeiro/api/boletos/gerar-lote/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                contratos: contratoIds,
                quantidade: quantidade
            })
        })
        .then(response => response.json())
        .then(data => {
            var resultadoDiv = document.getElementById('resultadoGeracaoLote');
            var conteudoDiv = document.getElementById('resultadoConteudo');

            if (data.sucesso) {
                var html = '<div class="alert alert-success mb-2">';
                html += '<strong>' + data.total_gerados + '</strong> boleto(s) gerado(s) em <strong>' + data.total_contratos + '</strong> contrato(s)';
                if (data.total_bloqueados > 0) {
                    html += '<br><small>' + data.total_bloqueados + ' parcela(s) bloqueada(s) por reajuste</small>';
                }
                html += '</div>';

                // Detalhes por contrato
                html += '<table class="table table-sm"><thead class="table-light"><tr><th>Contrato</th><th>Gerados</th><th>Bloqueados</th></tr></thead><tbody>';

                data.resultados.forEach(function(r) {
                    var trClass = r.sucesso ? '' : 'table-danger';
                    html += '<tr class="' + trClass + '">';
                    html += '<td>' + r.numero_contrato + '</td>';
                    html += '<td><span class="badge bg-success">' + r.gerados + '</span></td>';
                    html += '<td>';
                    if (r.bloqueados > 0) {
                        html += '<span class="badge bg-warning text-dark">' + r.bloqueados + '</span>';
                    } else {
                        html += '-';
                    }
                    html += '</td>';
                    html += '</tr>';
                });

                html += '</tbody></table>';

                conteudoDiv.innerHTML = html;
                resultadoDiv.classList.remove('d-none');

                showToast(data.mensagem, 'success');

                btn.innerHTML = '<i class="fas fa-check"></i> Concluido';
                btn.classList.remove('btn-success');
                btn.classList.add('btn-secondary');

                // Recarregar pagina apos 2 segundos
                setTimeout(function() {
                    location.reload();
                }, 2000);

            } else {
                showToast('Erro: ' + data.erro, 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-barcode"></i> Gerar Boletos';
            }
        })
        .catch(function(error) {
            showToast('Erro de conexao: ' + error, 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-barcode"></i> Gerar Boletos';
        });
    }
</script>
{% endblock %}
