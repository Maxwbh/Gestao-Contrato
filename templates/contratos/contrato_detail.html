{% extends 'base.html' %}
{% load format_filters %}

{% block title %}Contrato {{ contrato.numero_contrato }} - Gestao de Contratos{% endblock %}

{% block extra_css %}
<style>
    .info-card {
        border-left: 4px solid;
    }
    .info-card.primary { border-left-color: #0d6efd; }
    .info-card.success { border-left-color: #198754; }
    .info-card.warning { border-left-color: #ffc107; }
    .info-card.danger { border-left-color: #dc3545; }
    .info-card.info { border-left-color: #0dcaf0; }

    .info-item {
        padding: 0.5rem 0;
        border-bottom: 1px solid #eee;
    }
    .info-item:last-child {
        border-bottom: none;
    }
    .info-label {
        font-weight: 500;
        color: #6c757d;
        font-size: 0.85rem;
    }
    .info-value {
        font-weight: 600;
        color: #2c3e50;
    }

    .progress-lg {
        height: 25px;
        border-radius: 12px;
    }
    .progress-lg .progress-bar {
        font-size: 0.9rem;
        font-weight: 600;
    }

    .parcela-row.paga {
        background-color: #d1e7dd;
    }
    .parcela-row.atrasada {
        background-color: #f8d7da;
    }
    .parcela-row.proxima {
        background-color: #fff3cd;
    }

    .stat-card {
        text-align: center;
        padding: 1rem;
    }
    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
    }
    .stat-label {
        font-size: 0.8rem;
        color: #6c757d;
    }

    /* Toast Notifications */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
    }
    .toast-notification {
        min-width: 300px;
        padding: 15px 20px;
        margin-bottom: 10px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        animation: slideIn 0.3s ease-out;
    }
    .toast-notification.success {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
    }
    .toast-notification.error {
        background: linear-gradient(135deg, #dc3545, #e74c3c);
        color: white;
    }
    .toast-notification.info {
        background: linear-gradient(135deg, #17a2b8, #0dcaf0);
        color: white;
    }
    .toast-notification i {
        font-size: 1.2rem;
        margin-right: 12px;
    }
    .toast-notification .toast-close {
        margin-left: auto;
        cursor: pointer;
        opacity: 0.7;
    }
    .toast-notification .toast-close:hover {
        opacity: 1;
    }
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }

    /* Botao Loading */
    .btn-loading {
        position: relative;
        pointer-events: none;
    }
    .btn-loading .spinner-border {
        width: 1rem;
        height: 1rem;
        border-width: 2px;
    }

    /* Efeito de sucesso na linha */
    .parcela-row.boleto-gerado {
        animation: highlightSuccess 2s ease-out;
    }
    @keyframes highlightSuccess {
        0% { background-color: #d4edda; }
        100% { background-color: transparent; }
    }
</style>
{% endblock %}

{% block content %}
<!-- Toast Container -->
<div id="toastContainer" class="toast-container"></div>

<div class="row">
    <div class="col-12">
        <!-- Cabecalho -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-1">
                            <i class="fas fa-file-contract text-primary"></i>
                            Contrato {{ contrato.numero_contrato }}
                        </h3>
                        <p class="text-muted mb-0">
                            {{ contrato.comprador.nome }} | {{ contrato.imovel.identificacao }}
                        </p>
                    </div>
                    <div>
                        <span class="badge fs-5 {% if contrato.status == 'ATIVO' %}bg-success{% elif contrato.status == 'QUITADO' %}bg-primary{% elif contrato.status == 'CANCELADO' %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                            {{ contrato.get_status_display }}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estatisticas Rapidas -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stat-card border-primary">
                    <div class="stat-value text-primary">{{ contrato.valor_total|moeda }}</div>
                    <div class="stat-label">Valor Total</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-success">
                    <div class="stat-value text-success">{{ valor_pago|moeda }}</div>
                    <div class="stat-label">Valor Pago</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-warning">
                    <div class="stat-value text-warning">{{ saldo_devedor|moeda }}</div>
                    <div class="stat-label">Saldo Devedor</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stat-card border-info">
                    <div class="stat-value text-info">{{ parcelas_pagas }}/{{ contrato.numero_parcelas }}</div>
                    <div class="stat-label">Parcelas Pagas</div>
                </div>
            </div>
        </div>

        <!-- Barra de Progresso -->
        <div class="card mb-4">
            <div class="card-body">
                <h6 class="mb-3">Progresso do Pagamento</h6>
                <div class="progress progress-lg">
                    <div class="progress-bar {% if progresso >= 100 %}bg-success{% elif progresso >= 50 %}bg-info{% else %}bg-warning{% endif %}"
                         role="progressbar"
                         style="width: {{ progresso }}%"
                         aria-valuenow="{{ progresso }}"
                         aria-valuemin="0"
                         aria-valuemax="100">
                        {{ progresso|floatformat:1 }}%
                    </div>
                </div>
                <div class="d-flex justify-content-between mt-2 small text-muted">
                    <span>{{ parcelas_pagas }} parcelas pagas</span>
                    <span>{{ parcelas_pendentes }} parcelas pendentes</span>
                    {% if parcelas_atrasadas > 0 %}
                    <span class="text-danger fw-bold">{{ parcelas_atrasadas }} em atraso!</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Coluna Esquerda: Informacoes -->
            <div class="col-lg-5">
                <!-- Comprador -->
                <div class="card info-card primary mb-3">
                    <div class="card-header bg-primary text-white">
                        <i class="fas fa-user"></i> Comprador
                    </div>
                    <div class="card-body">
                        <div class="info-item">
                            <div class="info-label">Nome</div>
                            <div class="info-value">{{ contrato.comprador.nome }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">CPF/CNPJ</div>
                            <div class="info-value">{{ contrato.comprador.cpf_cnpj }}</div>
                        </div>
                        {% if contrato.comprador.telefone %}
                        <div class="info-item">
                            <div class="info-label">Telefone</div>
                            <div class="info-value">{{ contrato.comprador.telefone }}</div>
                        </div>
                        {% endif %}
                        {% if contrato.comprador.email %}
                        <div class="info-item">
                            <div class="info-label">E-mail</div>
                            <div class="info-value">{{ contrato.comprador.email }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Imovel -->
                <div class="card info-card success mb-3">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-home"></i> Imovel
                    </div>
                    <div class="card-body">
                        <div class="info-item">
                            <div class="info-label">Identificacao</div>
                            <div class="info-value">{{ contrato.imovel.identificacao }}</div>
                        </div>
                        {% if contrato.imovel.loteamento %}
                        <div class="info-item">
                            <div class="info-label">Loteamento</div>
                            <div class="info-value">{{ contrato.imovel.loteamento }}</div>
                        </div>
                        {% endif %}
                        <div class="info-item">
                            <div class="info-label">Tipo</div>
                            <div class="info-value">{{ contrato.imovel.get_tipo_display }}</div>
                        </div>
                        {% if contrato.imovel.area %}
                        <div class="info-item">
                            <div class="info-label">Area</div>
                            <div class="info-value">{{ contrato.imovel.area }} m2</div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Valores -->
                <div class="card info-card warning mb-3">
                    <div class="card-header bg-warning text-dark">
                        <i class="fas fa-dollar-sign"></i> Valores
                    </div>
                    <div class="card-body">
                        <div class="info-item">
                            <div class="info-label">Valor Total</div>
                            <div class="info-value">{{ contrato.valor_total|moeda }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Entrada</div>
                            <div class="info-value">{{ contrato.valor_entrada|moeda }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Valor Financiado</div>
                            <div class="info-value">{{ contrato.valor_financiado|moeda }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Valor Original Parcela</div>
                            <div class="info-value">{{ contrato.valor_parcela_original|moeda }}</div>
                        </div>
                    </div>
                </div>

                <!-- Configuracoes -->
                <div class="card info-card info mb-3">
                    <div class="card-header bg-info text-white">
                        <i class="fas fa-cog"></i> Configuracoes
                    </div>
                    <div class="card-body">
                        <div class="info-item">
                            <div class="info-label">Juros de Mora</div>
                            <div class="info-value">{{ contrato.percentual_juros_mora }}% a.m.</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Multa</div>
                            <div class="info-value">{{ contrato.percentual_multa }}%</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Correcao Monetaria</div>
                            <div class="info-value">{{ contrato.get_tipo_correcao_display }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Prazo Reajuste</div>
                            <div class="info-value">{{ contrato.prazo_reajuste_meses }} meses</div>
                        </div>
                        {% if contrato.data_proximo_reajuste %}
                        <div class="info-item">
                            <div class="info-label">Proximo Reajuste</div>
                            <div class="info-value text-warning">{{ contrato.data_proximo_reajuste|date:"d/m/Y" }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Conta Bancaria da Imobiliaria -->
                <div class="card info-card success mb-3">
                    <div class="card-header bg-success text-white">
                        <i class="fas fa-university"></i> Conta Bancaria
                    </div>
                    <div class="card-body">
                        {% if conta_bancaria %}
                        <div class="info-item">
                            <div class="info-label">Banco</div>
                            <div class="info-value">{{ conta_bancaria.get_banco_display }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Agencia</div>
                            <div class="info-value">{{ conta_bancaria.agencia }}{% if conta_bancaria.agencia_dv %}-{{ conta_bancaria.agencia_dv }}{% endif %}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Conta</div>
                            <div class="info-value">{{ conta_bancaria.conta }}{% if conta_bancaria.conta_dv %}-{{ conta_bancaria.conta_dv }}{% endif %}</div>
                        </div>
                        {% if conta_bancaria.convenio %}
                        <div class="info-item">
                            <div class="info-label">Convenio</div>
                            <div class="info-value">{{ conta_bancaria.convenio }}</div>
                        </div>
                        {% endif %}
                        <div class="info-item">
                            <div class="info-label">Carteira</div>
                            <div class="info-value">{{ conta_bancaria.carteira }}</div>
                        </div>
                        {% else %}
                        <div class="text-muted text-center py-2">
                            <i class="fas fa-exclamation-circle"></i> Nenhuma conta bancaria configurada
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Historico de Reajustes -->
                <div class="card mb-3">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-chart-line"></i> Reajustes</span>
                        <button type="button" class="btn btn-sm btn-light" onclick="abrirModalReajuste()">
                            <i class="fas fa-plus"></i> Novo
                        </button>
                    </div>
                    <div class="card-body p-0">
                        {% if reajustes %}
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>Data</th>
                                        <th>Indice</th>
                                        <th class="text-end">%</th>
                                        <th>Parcelas</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for reajuste in reajustes %}
                                    <tr>
                                        <td>{{ reajuste.data_reajuste|date:"d/m/Y" }}</td>
                                        <td>
                                            <span class="badge {% if reajuste.aplicado_manual %}bg-warning{% else %}bg-info{% endif %}">
                                                {{ reajuste.indice_tipo }}
                                            </span>
                                        </td>
                                        <td class="text-end">
                                            {% if reajuste.percentual >= 0 %}
                                            <span class="text-success">+{{ reajuste.percentual|floatformat:2 }}%</span>
                                            {% else %}
                                            <span class="text-danger">{{ reajuste.percentual|floatformat:2 }}%</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ reajuste.parcela_inicial }}-{{ reajuste.parcela_final }}</td>
                                        <td>
                                            {% if reajuste.aplicado_manual %}
                                            <button type="button" class="btn btn-sm btn-outline-danger"
                                                    onclick="excluirReajuste({{ reajuste.pk }})"
                                                    title="Excluir e reverter">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="p-3 text-center text-muted">
                            <i class="fas fa-info-circle"></i> Nenhum reajuste aplicado
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Coluna Direita: Parcelas -->
            <div class="col-lg-7">
                <div class="card">
                    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-list"></i> Parcelas</span>
                        <div>
                            {% if proxima_parcela %}
                            <span class="badge bg-warning text-dark me-2">
                                Proxima: {{ proxima_parcela.data_vencimento|date:"d/m/Y" }}
                            </span>
                            {% endif %}
                            <button type="button" class="btn btn-sm btn-success" onclick="abrirModalCarne()">
                                <i class="fas fa-file-invoice-dollar"></i> Gerar Carne
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th class="text-center">#</th>
                                        <th>Vencimento</th>
                                        <th class="text-end">Valor</th>
                                        <th class="text-center">Boleto</th>
                                        <th class="text-center">Status</th>
                                        <th class="text-center">Acoes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for parcela in parcelas %}
                                    <tr class="parcela-row {% if parcela.pago %}paga{% elif parcela.esta_atrasada %}atrasada{% elif parcela == proxima_parcela %}proxima{% endif %}">
                                        <td class="text-center">
                                            <strong>{{ parcela.numero_parcela }}</strong>
                                        </td>
                                        <td>{{ parcela.data_vencimento|date:"d/m/Y" }}</td>
                                        <td class="text-end">
                                            {{ parcela.valor_atual|moeda }}
                                            {% if parcela.pago %}
                                            <br><small class="text-muted">Pago: {{ parcela.valor_pago|moeda }}</small>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if parcela.tem_boleto %}
                                                <span class="badge bg-success" title="Boleto gerado">
                                                    <i class="fas fa-barcode"></i>
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary" title="Sem boleto">
                                                    <i class="fas fa-minus"></i>
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            {% if parcela.pago %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check"></i> Pago
                                                </span>
                                                <br><small>{{ parcela.data_pagamento|date:"d/m/Y" }}</small>
                                            {% elif parcela.esta_atrasada %}
                                                <span class="badge bg-danger">
                                                    <i class="fas fa-exclamation-triangle"></i> {{ parcela.dias_atraso }}d
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">
                                                    <i class="fas fa-clock"></i> Pendente
                                                </span>
                                            {% endif %}
                                        </td>
                                        <td class="text-center">
                                            <div class="btn-group btn-group-sm">
                                                {% if not parcela.pago %}
                                                    {% if parcela.tem_boleto %}
                                                        <button type="button" class="btn btn-outline-primary"
                                                                onclick="abrirModalBoleto({{ parcela.pk }})" title="Ver Boleto">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button type="button" class="btn btn-outline-warning"
                                                                onclick="regenerarBoleto({{ parcela.pk }}, this)" title="Atualizar Boleto">
                                                            <i class="fas fa-sync"></i>
                                                        </button>
                                                    {% else %}
                                                        <button type="button" class="btn btn-outline-success"
                                                                onclick="gerarBoleto({{ parcela.pk }}, this)" title="Gerar Boleto">
                                                            <i class="fas fa-barcode"></i>
                                                        </button>
                                                    {% endif %}
                                                    <button type="button" class="btn btn-outline-success"
                                                            onclick="abrirModalPagamento({{ parcela.pk }}, '{{ parcela.data_vencimento|date:"Y-m-d" }}', '{{ parcela.valor_atual|stringformat:"f" }}', '{{ contrato.percentual_juros_mora|stringformat:"f" }}', '{{ contrato.percentual_multa|stringformat:"f" }}')"
                                                            title="Registrar Pagamento">
                                                        <i class="fas fa-dollar-sign"></i>
                                                    </button>
                                                {% else %}
                                                    <span class="text-success" title="Parcela quitada">
                                                        <i class="fas fa-check-circle"></i>
                                                    </span>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            <i class="fas fa-info-circle"></i> Nenhuma parcela gerada
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Observacoes -->
                {% if contrato.observacoes %}
                <div class="card mt-3">
                    <div class="card-header bg-light">
                        <i class="fas fa-sticky-note"></i> Observacoes
                    </div>
                    <div class="card-body">
                        <p class="mb-0">{{ contrato.observacoes|linebreaks }}</p>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Botoes de Acao -->
        <div class="card mt-4">
            <div class="card-body d-flex justify-content-between">
                <a href="{% url 'contratos:listar' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar para Lista
                </a>
                <div>
                    <a href="{% url 'contratos:editar' contrato.pk %}" class="btn btn-primary">
                        <i class="fas fa-edit"></i> Editar Contrato
                    </a>
                    {% if contrato.status != 'CANCELADO' %}
                    <button type="button" class="btn btn-danger" onclick="confirmarCancelamento()">
                        <i class="fas fa-ban"></i> Cancelar Contrato
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Cancelamento -->
<div class="modal fade" id="modalCancelamento" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i> Confirmar Cancelamento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Tem certeza que deseja cancelar o contrato <strong>{{ contrato.numero_contrato }}</strong>?</p>
                {% if parcelas_pagas > 0 %}
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    <strong>Atencao:</strong> Este contrato possui {{ parcelas_pagas }} parcela(s) paga(s).
                    O cancelamento NAO sera permitido.
                </div>
                {% else %}
                <p class="text-warning">
                    <i class="fas fa-info-circle"></i> O imovel sera liberado para novas vendas.
                </p>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Voltar
                </button>
                {% if parcelas_pagas == 0 %}
                <form action="{% url 'contratos:excluir' contrato.pk %}" method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-ban"></i> Confirmar Cancelamento
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal de Pagamento -->
<div class="modal fade" id="modalPagamento" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-dollar-sign"></i> Registrar Pagamento
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="formPagamento" method="post">
                {% csrf_token %}
                <input type="hidden" id="pagamento_parcela_id" name="parcela_id">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Data de Vencimento</label>
                                <input type="date" class="form-control" id="pagamento_vencimento" readonly>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Data de Pagamento <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="pagamento_data" name="data_pagamento" required onchange="calcularEncargos()">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Valor Original</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="text" class="form-control" id="pagamento_valor_original" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Juros (editavel)</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" step="0.01" class="form-control" id="pagamento_juros" name="valor_juros" value="0" onchange="calcularTotal()">
                                </div>
                                <small class="text-muted" id="juros_info"></small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Multa (editavel)</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" step="0.01" class="form-control" id="pagamento_multa" name="valor_multa" value="0" onchange="calcularTotal()">
                                </div>
                                <small class="text-muted" id="multa_info"></small>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Desconto (editavel)</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" step="0.01" class="form-control" id="pagamento_desconto" name="valor_desconto" value="0" onchange="calcularTotal()">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Valor a Pagar</label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" step="0.01" class="form-control fw-bold fs-5" id="pagamento_valor_pagar" name="valor_pago" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observacoes</label>
                        <textarea class="form-control" name="observacoes" rows="2"></textarea>
                    </div>
                    <div id="alertaAtraso" class="alert alert-warning d-none">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="alertaAtrasoTexto"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Confirmar Pagamento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Gerar Carne -->
<div class="modal fade" id="modalCarne" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-file-invoice-dollar"></i> Gerar Boletos
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="formCarne" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <!-- Informacoes do Ciclo de Reajuste -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block">Tipo de Correcao</small>
                                    <strong>{{ contrato.get_tipo_correcao_display }}</strong>
                                    {% if contrato.tipo_correcao == 'FIXO' %}
                                    <span class="badge bg-success ms-2">Sem reajuste</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <small class="text-muted d-block">Prazo de Reajuste</small>
                                    <strong>{{ contrato.prazo_reajuste_meses }} meses</strong>
                                    {% if contrato.tipo_correcao != 'FIXO' %}
                                    <small class="text-muted">(Ciclo atual: {{ contrato.ciclo_reajuste_atual|default:1 }})</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Alerta de Reajuste Necessario -->
                    <div id="alertaReajusteInfo" class="alert alert-warning d-none">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-sync-alt fa-2x me-3"></i>
                            <div>
                                <strong>Reajuste Necessario</strong>
                                <p class="mb-0" id="alertaReajusteInfoTexto"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Resumo de Parcelas -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="text-center p-2 border rounded bg-success bg-opacity-10">
                                <div class="fs-4 fw-bold text-success" id="totalDisponiveis">-</div>
                                <small>Disponiveis</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-2 border rounded bg-warning bg-opacity-10">
                                <div class="fs-4 fw-bold text-warning" id="totalBloqueadas">-</div>
                                <small>Bloqueadas (reajuste)</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center p-2 border rounded bg-info bg-opacity-10">
                                <div class="fs-4 fw-bold text-info" id="totalJaGeradas">-</div>
                                <small>Ja com boleto</small>
                            </div>
                        </div>
                    </div>

                    <!-- Selecao de Quantidade -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Quantidade de Boletos a Gerar</label>
                        <div class="input-group">
                            <button type="button" class="btn btn-outline-secondary" onclick="setQuantidade(1)">1</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="setQuantidade(6)">6</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="setQuantidade(12)">12</button>
                            <input type="number" class="form-control text-center" id="carne_quantidade" name="quantidade" min="1" value="1" required style="max-width: 100px;">
                            <button type="button" class="btn btn-outline-primary" id="btnMaxDisponiveis" onclick="setQuantidadeMax()">Max</button>
                        </div>
                        <small class="text-muted" id="quantidadeInfo"></small>
                    </div>

                    <!-- Preview das Parcelas -->
                    <div class="mb-3">
                        <label class="form-label">Parcelas que serao geradas:</label>
                        <div id="preview_parcelas" class="border rounded" style="max-height: 250px; overflow-y: auto;">
                            <div class="text-center py-3 text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Carregando...
                            </div>
                        </div>
                    </div>

                    <!-- Alerta de Bloqueio -->
                    <div id="alertaReajuste" class="alert alert-danger d-none">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="alertaReajusteTexto"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnGerarCarne" disabled>
                        <i class="fas fa-barcode"></i> Gerar <span id="btnGerarQtd">0</span> Boleto(s)
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal de Visualizacao do Boleto -->
<div class="modal fade" id="modalBoleto" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-barcode"></i> Dados do Boleto
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="iframeBoleto" style="width: 100%; height: 70vh; border: none;"></iframe>
            </div>
            <div class="modal-footer">
                <a id="btnDownloadBoleto" href="#" class="btn btn-primary" target="_blank">
                    <i class="fas fa-download"></i> Download PDF
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Reajuste Manual -->
<div class="modal fade" id="modalReajuste" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line"></i> Aplicar Reajuste Manual
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="formReajuste" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        O reajuste sera aplicado apenas nas parcelas <strong>nao pagas</strong> dentro do intervalo selecionado.
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Tipo de Indice <span class="text-danger">*</span></label>
                        <select name="indice_tipo" id="reajuste_indice" class="form-select" required onchange="buscarPercentualIndice()">
                            <option value="">Selecione...</option>
                            {% for codigo, nome in tipos_indice %}
                            <option value="{{ codigo }}">{{ nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Percentual de Reajuste (%) <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="number" step="0.0001" class="form-control" id="reajuste_percentual" name="percentual" required placeholder="Ex: 5.25">
                            <span class="input-group-text">%</span>
                            <button type="button" class="btn btn-outline-secondary" onclick="calcularReajusteProporcional()" title="Calcular reajuste acumulado proporcional">
                                <i class="fas fa-calculator"></i> Calcular
                            </button>
                        </div>
                        <small class="text-muted" id="reajuste_info"></small>
                    </div>

                    <div id="detalhesCalculo" class="alert alert-secondary d-none" style="max-height: 150px; overflow-y: auto;">
                        <h6><i class="fas fa-info-circle"></i> Detalhes do Calculo</h6>
                        <div id="detalhesCalculoConteudo"></div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Parcela Inicial <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="reajuste_parcela_inicial" name="parcela_inicial" min="1" max="{{ contrato.numero_parcelas }}" value="1" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Parcela Final <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="reajuste_parcela_final" name="parcela_final" min="1" max="{{ contrato.numero_parcelas }}" value="{{ contrato.numero_parcelas }}" required>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Observacoes</label>
                        <textarea class="form-control" name="observacoes" rows="2" placeholder="Motivo do reajuste manual..."></textarea>
                    </div>

                    <div id="previewReajuste" class="border rounded p-3 bg-light d-none">
                        <h6><i class="fas fa-calculator"></i> Previa do Reajuste</h6>
                        <p class="mb-1">Parcelas afetadas: <strong id="preview_qtd">0</strong></p>
                        <p class="mb-0">Novo valor aproximado: <strong id="preview_novo_valor">R$ 0,00</strong></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="btnAplicarReajuste">
                        <i class="fas fa-check"></i> Aplicar Reajuste
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Dados das parcelas para o modal de carne
var parcelasPendentes = [
    {% for parcela in parcelas %}{% if not parcela.pago and not parcela.tem_boleto %}
    {id: {{ parcela.pk }}, numero: {{ parcela.numero_parcela }}, vencimento: '{{ parcela.data_vencimento|date:"d/m/Y" }}', valor: parseFloat('{{ parcela.valor_atual|stringformat:"f" }}'.replace(',', '.')) || 0},
    {% endif %}{% endfor %}
];

var dataReajuste = '{{ contrato.data_proximo_reajuste|date:"Y-m-d"|default:"" }}';

// Variaveis para calculo de pagamento
var pagamentoValorOriginal = 0;
var pagamentoTaxaJuros = 0;
var pagamentoTaxaMulta = 0;
var pagamentoVencimento = null;

function confirmarCancelamento() {
    new bootstrap.Modal(document.getElementById('modalCancelamento')).show();
}

// ============ FUNCOES DE BOLETO ============

function abrirModalBoleto(parcelaId) {
    var iframe = document.getElementById('iframeBoleto');
    var btnDownload = document.getElementById('btnDownloadBoleto');

    // Configurar URLs
    var urlVisualizar = '/financeiro/parcelas/' + parcelaId + '/boleto/visualizar/';
    var urlDownload = '/financeiro/parcelas/' + parcelaId + '/boleto/download/';

    // Carregar no iframe
    iframe.src = urlVisualizar;
    btnDownload.href = urlDownload;

    // Abrir modal
    new bootstrap.Modal(document.getElementById('modalBoleto')).show();
}

// ============ FUNCOES DE TOAST ============

function showToast(message, type = 'success', duration = 4000) {
    var container = document.getElementById('toastContainer');
    var toast = document.createElement('div');
    toast.className = 'toast-notification ' + type;

    var icon = type === 'success' ? 'fa-check-circle' :
               type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';

    toast.innerHTML = '<i class="fas ' + icon + '"></i>' +
                      '<span>' + message + '</span>' +
                      '<span class="toast-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></span>';

    container.appendChild(toast);

    setTimeout(function() {
        toast.style.animation = 'slideOut 0.3s ease-out forwards';
        setTimeout(function() { toast.remove(); }, 300);
    }, duration);
}

// ============ FUNCOES DE BOLETO ============

function gerarBoleto(parcelaId, btn) {
    // Encontrar o botao se nao foi passado
    if (!btn) {
        btn = document.querySelector('button[onclick*="gerarBoleto(' + parcelaId + ')"]');
    }

    // Mostrar loading no botao
    var originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    btn.classList.add('btn-loading');
    btn.disabled = true;

    fetch('/financeiro/parcelas/' + parcelaId + '/boleto/gerar/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.sucesso) {
            showToast('Boleto gerado com sucesso! Nosso Numero: ' + data.nosso_numero, 'success');

            // Atualizar a linha da parcela
            var row = btn.closest('tr');
            if (row) {
                row.classList.add('boleto-gerado');

                // Atualizar coluna de boleto
                var boletoCol = row.querySelector('td:nth-child(4)');
                if (boletoCol) {
                    boletoCol.innerHTML = '<span class="badge bg-success" title="Boleto gerado"><i class="fas fa-barcode"></i></span>';
                }

                // Atualizar botoes de acao
                var acoesCol = row.querySelector('td:last-child .btn-group');
                if (acoesCol) {
                    acoesCol.innerHTML =
                        '<button type="button" class="btn btn-outline-primary" onclick="abrirModalBoleto(' + parcelaId + ')" title="Ver Boleto"><i class="fas fa-eye"></i></button>' +
                        '<button type="button" class="btn btn-outline-warning" onclick="regenerarBoleto(' + parcelaId + ', this)" title="Atualizar Boleto"><i class="fas fa-sync"></i></button>' +
                        '<button type="button" class="btn btn-outline-success" onclick="abrirModalPagamento(' + parcelaId + ')" title="Registrar Pagamento"><i class="fas fa-dollar-sign"></i></button>';
                }
            }

            // Abrir boleto em nova aba apos um pequeno delay
            setTimeout(function() {
                window.open('/financeiro/parcelas/' + parcelaId + '/boleto/visualizar/?popup=true', '_blank');
            }, 500);

        } else {
            showToast('Erro ao gerar boleto: ' + data.erro, 'error', 6000);
            // Restaurar botao
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-loading');
            btn.disabled = false;
        }
    })
    .catch(error => {
        showToast('Erro de conexao: ' + error, 'error', 6000);
        btn.innerHTML = originalHtml;
        btn.classList.remove('btn-loading');
        btn.disabled = false;
    });
}

function regenerarBoleto(parcelaId, btn) {
    // Encontrar o botao se nao foi passado
    if (!btn) {
        btn = document.querySelector('button[onclick*="regenerarBoleto(' + parcelaId + ')"]');
    }

    // Mostrar loading no botao
    var originalHtml = btn.innerHTML;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    btn.classList.add('btn-loading');
    btn.disabled = true;

    fetch('/financeiro/parcelas/' + parcelaId + '/boleto/gerar/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: 'force=true'
    })
    .then(response => response.json())
    .then(data => {
        if (data.sucesso) {
            showToast('Boleto atualizado com sucesso!', 'success');

            // Efeito visual na linha
            var row = btn.closest('tr');
            if (row) {
                row.classList.add('boleto-gerado');
            }

            // Restaurar botao
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-loading');
            btn.disabled = false;

            // Abrir boleto em popup modal
            setTimeout(function() {
                abrirModalBoleto(parcelaId);
            }, 500);

        } else {
            showToast('Erro ao atualizar boleto: ' + data.erro, 'error', 6000);
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-loading');
            btn.disabled = false;
        }
    })
    .catch(error => {
        showToast('Erro de conexao: ' + error, 'error', 6000);
        btn.innerHTML = originalHtml;
        btn.classList.remove('btn-loading');
        btn.disabled = false;
    });
}

// ============ FUNCOES DE PAGAMENTO ============

function abrirModalPagamento(parcelaId, vencimento, valorOriginal, taxaJuros, taxaMulta) {
    // Converter strings para nmeros (tratando possveis vrgulas)
    var valorOriginalStr = String(valorOriginal).replace(',', '.');
    var taxaJurosStr = String(taxaJuros).replace(',', '.');
    var taxaMultaStr = String(taxaMulta).replace(',', '.');

    pagamentoValorOriginal = parseFloat(valorOriginalStr) || 0;
    pagamentoTaxaJuros = parseFloat(taxaJurosStr) || 0;
    pagamentoTaxaMulta = parseFloat(taxaMultaStr) || 0;
    pagamentoVencimento = new Date(vencimento + 'T00:00:00');

    document.getElementById('pagamento_parcela_id').value = parcelaId;
    document.getElementById('pagamento_vencimento').value = vencimento;
    document.getElementById('pagamento_valor_original').value = pagamentoValorOriginal.toFixed(2);
    document.getElementById('pagamento_data').value = new Date().toISOString().split('T')[0];
    document.getElementById('pagamento_juros').value = '0';
    document.getElementById('pagamento_multa').value = '0';
    document.getElementById('pagamento_desconto').value = '0';

    document.getElementById('juros_info').textContent = pagamentoTaxaJuros + '% a.m.';
    document.getElementById('multa_info').textContent = pagamentoTaxaMulta + '%';

    calcularEncargos();
    new bootstrap.Modal(document.getElementById('modalPagamento')).show();
}

function calcularEncargos() {
    var dataPagamento = new Date(document.getElementById('pagamento_data').value + 'T00:00:00');
    var diasAtraso = Math.floor((dataPagamento - pagamentoVencimento) / (1000 * 60 * 60 * 24));

    var alertaDiv = document.getElementById('alertaAtraso');
    var alertaTexto = document.getElementById('alertaAtrasoTexto');

    if (diasAtraso > 0) {
        // Calcular juros (proporcional aos dias)
        var juros = pagamentoValorOriginal * (pagamentoTaxaJuros / 100) * (diasAtraso / 30);
        // Calcular multa (valor fixo)
        var multa = pagamentoValorOriginal * (pagamentoTaxaMulta / 100);

        document.getElementById('pagamento_juros').value = juros.toFixed(2);
        document.getElementById('pagamento_multa').value = multa.toFixed(2);

        if (alertaDiv) alertaDiv.classList.remove('d-none');
        if (alertaTexto) alertaTexto.textContent = 'Parcela em atraso ha ' + diasAtraso + ' dia(s). Juros e multa calculados automaticamente.';
    } else {
        document.getElementById('pagamento_juros').value = '0';
        document.getElementById('pagamento_multa').value = '0';
        if (alertaDiv) alertaDiv.classList.add('d-none');
    }

    calcularTotal();
}

function calcularTotal() {
    var valorOriginal = parseFloat(document.getElementById('pagamento_valor_original').value) || 0;
    var juros = parseFloat(document.getElementById('pagamento_juros').value) || 0;
    var multa = parseFloat(document.getElementById('pagamento_multa').value) || 0;
    var desconto = parseFloat(document.getElementById('pagamento_desconto').value) || 0;

    var total = valorOriginal + juros + multa - desconto;
    document.getElementById('pagamento_valor_pagar').value = total.toFixed(2);
}

document.getElementById('formPagamento').addEventListener('submit', function(e) {
    e.preventDefault();

    var parcelaId = document.getElementById('pagamento_parcela_id').value;
    var formData = new FormData(this);

    fetch('/financeiro/parcelas/' + parcelaId + '/pagar-ajax/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.sucesso) {
            alert('Pagamento registrado com sucesso!');
            location.reload();
        } else {
            alert('Erro ao registrar pagamento: ' + data.erro);
        }
    })
    .catch(error => alert('Erro de conexao: ' + error));
});

// ============ FUNCOES DE CARNE ============

// Dados de elegibilidade de parcelas (carregados via API)
var dadosElegibilidade = null;

function abrirModalCarne() {
    // Reset estado
    document.getElementById('carne_quantidade').value = 1;
    document.getElementById('preview_parcelas').innerHTML = '<div class="text-center py-3 text-muted"><i class="fas fa-spinner fa-spin"></i> Carregando...</div>';
    document.getElementById('btnGerarCarne').disabled = true;

    // Abrir modal
    new bootstrap.Modal(document.getElementById('modalCarne')).show();

    // Carregar dados de elegibilidade via API
    carregarElegibilidade();
}

function carregarElegibilidade() {
    fetch('/financeiro/api/contrato/{{ contrato.pk }}/parcelas-elegibilidade/')
    .then(response => response.json())
    .then(data => {
        if (data.sucesso) {
            dadosElegibilidade = data;
            atualizarResumoElegibilidade();
            atualizarPreviewCarne();
        } else {
            document.getElementById('preview_parcelas').innerHTML = '<div class="text-center py-3 text-danger"><i class="fas fa-exclamation-circle"></i> Erro ao carregar: ' + data.erro + '</div>';
        }
    })
    .catch(error => {
        document.getElementById('preview_parcelas').innerHTML = '<div class="text-center py-3 text-danger"><i class="fas fa-exclamation-circle"></i> Erro de conexao</div>';
    });
}

function atualizarResumoElegibilidade() {
    if (!dadosElegibilidade) return;

    var totalDisponiveis = dadosElegibilidade.total_disponiveis || 0;
    var totalBloqueadas = dadosElegibilidade.total_bloqueadas || 0;
    var totalJaGeradas = dadosElegibilidade.parcelas.filter(function(p) { return p.tem_boleto && p.pode_gerar; }).length;

    document.getElementById('totalDisponiveis').textContent = totalDisponiveis;
    document.getElementById('totalBloqueadas').textContent = totalBloqueadas;
    document.getElementById('totalJaGeradas').textContent = totalJaGeradas;

    // Atualizar max do input
    var parcelasParaGerar = dadosElegibilidade.parcelas.filter(function(p) { return p.pode_gerar && !p.tem_boleto; }).length;
    document.getElementById('carne_quantidade').max = parcelasParaGerar;
    document.getElementById('quantidadeInfo').textContent = parcelasParaGerar + ' parcela(s) disponivel(eis) para geracao';

    // Mostrar alerta de reajuste se necessario
    var alertaInfo = document.getElementById('alertaReajusteInfo');
    var alertaInfoTexto = document.getElementById('alertaReajusteInfoTexto');

    if (dadosElegibilidade.proximo_ciclo_reajuste && !dadosElegibilidade.tipo_correcao_fixo) {
        alertaInfo.classList.remove('d-none');
        alertaInfoTexto.textContent = dadosElegibilidade.proximo_ciclo_reajuste.mensagem;
    } else {
        alertaInfo.classList.add('d-none');
    }

    // Atualizar botao max
    document.getElementById('btnMaxDisponiveis').textContent = 'Max (' + parcelasParaGerar + ')';
}

function setQuantidade(qtd) {
    var input = document.getElementById('carne_quantidade');
    var max = parseInt(input.max) || 1;
    input.value = Math.min(qtd, max);
    atualizarPreviewCarne();
}

function setQuantidadeMax() {
    var input = document.getElementById('carne_quantidade');
    input.value = input.max;
    atualizarPreviewCarne();
}

document.getElementById('carne_quantidade').addEventListener('change', atualizarPreviewCarne);
document.getElementById('carne_quantidade').addEventListener('input', atualizarPreviewCarne);

function atualizarPreviewCarne() {
    if (!dadosElegibilidade) return;

    var qtd = parseInt(document.getElementById('carne_quantidade').value) || 0;
    var previewDiv = document.getElementById('preview_parcelas');
    var alertaDiv = document.getElementById('alertaReajuste');
    var alertaTexto = document.getElementById('alertaReajusteTexto');
    var btnGerar = document.getElementById('btnGerarCarne');
    var btnGerarQtd = document.getElementById('btnGerarQtd');

    // Filtrar parcelas que podem ser geradas (sem boleto e elegiveis)
    var parcelasDisponiveis = dadosElegibilidade.parcelas.filter(function(p) {
        return p.pode_gerar && !p.tem_boleto;
    });

    var parcelasBloqueadas = dadosElegibilidade.parcelas.filter(function(p) {
        return !p.pode_gerar && !p.tem_boleto;
    });

    if (qtd < 1 || parcelasDisponiveis.length === 0) {
        previewDiv.innerHTML = '<div class="text-center py-3 text-muted"><i class="fas fa-info-circle"></i> Nenhuma parcela disponivel para geracao</div>';
        btnGerar.disabled = true;
        btnGerarQtd.textContent = '0';
        return;
    }

    var html = '<table class="table table-sm table-hover mb-0">';
    html += '<thead class="table-light"><tr><th>#</th><th>Vencimento</th><th class="text-end">Valor</th><th>Ciclo</th><th>Status</th></tr></thead><tbody>';

    var parcelasParaGerar = [];

    // Primeiro as disponiveis (ate a quantidade solicitada)
    for (var i = 0; i < Math.min(qtd, parcelasDisponiveis.length); i++) {
        var p = parcelasDisponiveis[i];
        parcelasParaGerar.push(p.id);
        html += '<tr class="table-success">';
        html += '<td><strong>' + p.numero_parcela + '</strong></td>';
        html += '<td>' + p.data_vencimento + '</td>';
        html += '<td class="text-end">R$ ' + p.valor_atual.toFixed(2) + '</td>';
        html += '<td><span class="badge bg-info">' + p.ciclo + '</span></td>';
        html += '<td><i class="fas fa-check text-success"></i> Sera gerado</td>';
        html += '</tr>';
    }

    // Mostrar algumas bloqueadas (se houver)
    if (parcelasBloqueadas.length > 0) {
        html += '<tr class="table-secondary"><td colspan="5" class="text-center fw-bold py-2"><i class="fas fa-lock"></i> Bloqueadas (aguardando reajuste)</td></tr>';
        for (var j = 0; j < Math.min(3, parcelasBloqueadas.length); j++) {
            var pb = parcelasBloqueadas[j];
            html += '<tr class="text-muted">';
            html += '<td>' + pb.numero_parcela + '</td>';
            html += '<td>' + pb.data_vencimento + '</td>';
            html += '<td class="text-end">R$ ' + pb.valor_atual.toFixed(2) + '</td>';
            html += '<td><span class="badge bg-warning text-dark">' + pb.ciclo + '</span></td>';
            html += '<td><small>' + pb.motivo + '</small></td>';
            html += '</tr>';
        }
        if (parcelasBloqueadas.length > 3) {
            html += '<tr class="text-muted"><td colspan="5" class="text-center">... e mais ' + (parcelasBloqueadas.length - 3) + ' parcela(s) bloqueada(s)</td></tr>';
        }
    }

    html += '</tbody></table>';
    previewDiv.innerHTML = html;

    // Atualizar botao
    btnGerar.disabled = parcelasParaGerar.length === 0;
    btnGerarQtd.textContent = parcelasParaGerar.length;

    // Alerta se houver bloqueio
    if (parcelasBloqueadas.length > 0 && qtd > parcelasDisponiveis.length) {
        alertaDiv.classList.remove('d-none');
        alertaTexto.textContent = 'Algumas parcelas estao bloqueadas aguardando reajuste. Aplique o reajuste do ciclo ' + parcelasBloqueadas[0].ciclo + ' para libera-las.';
    } else {
        alertaDiv.classList.add('d-none');
    }
}

document.getElementById('formCarne').addEventListener('submit', function(e) {
    e.preventDefault();

    if (!dadosElegibilidade) {
        alert('Dados de elegibilidade nao carregados');
        return;
    }

    var qtd = parseInt(document.getElementById('carne_quantidade').value) || 0;
    if (qtd < 1) {
        alert('Selecione pelo menos 1 parcela');
        return;
    }

    // Coletar IDs das parcelas disponiveis
    var parcelasDisponiveis = dadosElegibilidade.parcelas.filter(function(p) {
        return p.pode_gerar && !p.tem_boleto;
    });

    var parcelaIds = [];
    for (var i = 0; i < Math.min(qtd, parcelasDisponiveis.length); i++) {
        parcelaIds.push(parcelasDisponiveis[i].id);
    }

    if (parcelaIds.length === 0) {
        alert('Nenhuma parcela disponivel para gerar boleto');
        return;
    }

    var btn = document.getElementById('btnGerarCarne');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Gerando ' + parcelaIds.length + ' boleto(s)...';

    fetch('/financeiro/contrato/{{ contrato.pk }}/gerar-carne/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({parcelas: parcelaIds})
    })
    .then(response => response.json())
    .then(data => {
        if (data.sucesso) {
            var msg = data.gerados + ' boleto(s) gerado(s) com sucesso!';
            if (data.bloqueados > 0) {
                msg += '\n' + data.bloqueados + ' parcela(s) bloqueada(s) por reajuste.';
            }
            showToast(msg, 'success');
            setTimeout(function() { location.reload(); }, 1500);
        } else {
            showToast('Erro ao gerar boletos: ' + data.erro, 'error');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-barcode"></i> Gerar <span id="btnGerarQtd">' + parcelaIds.length + '</span> Boleto(s)';
        }
    })
    .catch(error => {
        showToast('Erro de conexao: ' + error, 'error');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-barcode"></i> Gerar <span id="btnGerarQtd">' + parcelaIds.length + '</span> Boleto(s)';
    });
});

// ============ FUNCOES DE REAJUSTE ============

// Dados das parcelas para calculo de reajuste
var todasParcelas = [
    {% for parcela in parcelas %}
    {id: {{ parcela.pk }}, numero: {{ parcela.numero_parcela }}, valor: parseFloat('{{ parcela.valor_atual|stringformat:"f" }}'.replace(',', '.')) || 0, pago: {% if parcela.pago %}true{% else %}false{% endif %}},
    {% endfor %}
];

function abrirModalReajuste() {
    document.getElementById('reajuste_indice').value = '';
    document.getElementById('reajuste_percentual').value = '';
    document.getElementById('reajuste_parcela_inicial').value = 1;
    document.getElementById('reajuste_parcela_final').value = {{ contrato.numero_parcelas }};
    document.getElementById('reajuste_info').textContent = '';

    // Mostrar modal primeiro, depois ocultar elementos (para garantir que estao no DOM)
    var modal = new bootstrap.Modal(document.getElementById('modalReajuste'));
    modal.show();

    // Executar apos modal estar visivel
    setTimeout(function() {
        var previewEl = document.getElementById('previewReajuste');
        var detalhesEl = document.getElementById('detalhesCalculo');
        if (previewEl) previewEl.classList.add('d-none');
        if (detalhesEl) detalhesEl.classList.add('d-none');
    }, 100);
}

function buscarPercentualIndice() {
    var tipoIndice = document.getElementById('reajuste_indice').value;
    var infoSpan = document.getElementById('reajuste_info');

    if (!tipoIndice || tipoIndice === 'MANUAL') {
        infoSpan.textContent = tipoIndice === 'MANUAL' ? 'Informe o percentual manualmente ou clique em Calcular' : '';
        document.getElementById('detalhesCalculo').classList.add('d-none');
        return;
    }

    infoSpan.textContent = 'Selecione e clique em Calcular para obter o reajuste acumulado proporcional';
}

function calcularReajusteProporcional() {
    var tipoIndice = document.getElementById('reajuste_indice').value;
    var infoSpan = document.getElementById('reajuste_info');
    var detalhesDiv = document.getElementById('detalhesCalculo');
    var detalhesConteudo = document.getElementById('detalhesCalculoConteudo');

    if (!tipoIndice) {
        alert('Selecione um tipo de indice primeiro');
        return;
    }

    if (tipoIndice === 'MANUAL') {
        alert('Para indice manual, informe o percentual diretamente');
        return;
    }

    infoSpan.textContent = 'Calculando reajuste proporcional...';

    // Usar a nova API que segue a metodologia Calculo Exato
    fetch('/financeiro/contrato/{{ contrato.pk }}/reajuste/calcular/?tipo_indice=' + tipoIndice)
    .then(response => response.json())
    .then(data => {
        if (data.sucesso) {
            document.getElementById('reajuste_percentual').value = data.percentual_acumulado.toFixed(4);
            infoSpan.textContent = 'Reajuste acumulado ' + tipoIndice + ' de ' + data.data_inicio + ' a ' + data.data_fim + ': ' + data.percentual_acumulado.toFixed(4) + '%';

            // Mostrar detalhes do calculo (metodologia Calculo Exato)
            var html = '<small>';
            html += '<div class="mb-2 p-2 bg-info bg-opacity-10 rounded">';
            html += '<strong><i class="fas fa-calculator me-1"></i>Metodologia: Calculo Exato</strong>';
            html += '<p class="mb-0 mt-1" style="font-size: 0.75rem;">Fator = (1 + i<sub>1</sub>/100)  (1 + i<sub>2</sub>/100)  ...  (1 + i<sub>n</sub>/100)</p>';
            html += '</div>';
            html += '<p class="mb-1"><strong>Periodo:</strong> ' + data.data_inicio + ' a ' + data.data_fim + '</p>';
            html += '<p class="mb-1"><strong>Total de meses:</strong> ' + data.total_meses + '</p>';
            html += '<p class="mb-2"><strong>Fator de multiplicacao:</strong> ' + data.fator_acumulado.toFixed(6) + '</p>';
            html += '<table class="table table-sm table-bordered mb-2" style="font-size: 0.75rem;">';
            html += '<thead class="table-light"><tr><th>Mes/Ano</th><th>Indice (%)</th><th>Dias</th><th>Prop. (%)</th><th>Fator</th></tr></thead><tbody>';

            for (var i = 0; i < data.meses_detalhes.length; i++) {
                var m = data.meses_detalhes[i];
                var indiceOriginal = m.indice_original !== null ? m.indice_original.toFixed(2) : '-';
                var indiceProp = m.indice_proporcional !== undefined ? m.indice_proporcional.toFixed(4) : '0.0000';
                html += '<tr>';
                html += '<td>' + m.mes + '/' + m.ano + '</td>';
                html += '<td class="text-end">' + indiceOriginal + '</td>';
                html += '<td class="text-center">' + m.dias_considerados + '/' + m.dias_mes + '</td>';
                html += '<td class="text-end">' + indiceProp + '</td>';
                html += '<td class="text-end">' + (1 + parseFloat(indiceProp) / 100).toFixed(6) + '</td>';
                html += '</tr>';
            }

            html += '</tbody>';
            html += '<tfoot class="table-light">';
            html += '<tr><td colspan="4" class="text-end"><strong>Fator Acumulado:</strong></td>';
            html += '<td class="text-end"><strong>' + data.fator_acumulado.toFixed(6) + '</strong></td></tr>';
            html += '<tr><td colspan="4" class="text-end"><strong>Percentual Total:</strong></td>';
            html += '<td class="text-end"><strong class="text-success">' + data.percentual_acumulado.toFixed(4) + '%</strong></td></tr>';
            html += '</tfoot></table>';
            html += '<p class="mb-0 text-muted" style="font-size: 0.7rem;"><i class="fas fa-info-circle me-1"></i>Percentual = (Fator - 1)  100</p>';
            html += '</small>';

            detalhesConteudo.innerHTML = html;
            detalhesDiv.classList.remove('d-none');

            atualizarPreviewReajuste();
        } else {
            infoSpan.textContent = data.erro;
            detalhesDiv.classList.add('d-none');
        }
    })
    .catch(error => {
        infoSpan.textContent = 'Erro ao calcular reajuste: ' + error;
        detalhesDiv.classList.add('d-none');
    });
}

function atualizarPreviewReajuste() {
    var percentual = parseFloat(document.getElementById('reajuste_percentual').value) || 0;
    var parcelaInicial = parseInt(document.getElementById('reajuste_parcela_inicial').value) || 1;
    var parcelaFinal = parseInt(document.getElementById('reajuste_parcela_final').value) || {{ contrato.numero_parcelas }};

    var previewDiv = document.getElementById('previewReajuste');
    var qtdAfetadas = 0;
    var valorTotalNovo = 0;

    for (var i = 0; i < todasParcelas.length; i++) {
        var p = todasParcelas[i];
        if (!p.pago && p.numero >= parcelaInicial && p.numero <= parcelaFinal) {
            qtdAfetadas++;
            valorTotalNovo += p.valor * (1 + percentual / 100);
        }
    }

    if (percentual !== 0 && qtdAfetadas > 0) {
        document.getElementById('preview_qtd').textContent = qtdAfetadas;
        document.getElementById('preview_novo_valor').textContent = 'R$ ' + valorTotalNovo.toFixed(2);
        previewDiv.classList.remove('d-none');
    } else {
        previewDiv.classList.add('d-none');
    }
}

// Event listeners para preview de reajuste
document.getElementById('reajuste_percentual').addEventListener('input', atualizarPreviewReajuste);
document.getElementById('reajuste_parcela_inicial').addEventListener('change', atualizarPreviewReajuste);
document.getElementById('reajuste_parcela_final').addEventListener('change', atualizarPreviewReajuste);

document.getElementById('formReajuste').addEventListener('submit', function(e) {
    e.preventDefault();

    var percentual = parseFloat(document.getElementById('reajuste_percentual').value) || 0;
    if (percentual === 0) {
        alert('Informe um percentual de reajuste valido');
        return;
    }

    var tipoIndice = document.getElementById('reajuste_indice').value;
    var parcelaInicial = parseInt(document.getElementById('reajuste_parcela_inicial').value);
    var parcelaFinal = parseInt(document.getElementById('reajuste_parcela_final').value);
    var observacoes = document.querySelector('#formReajuste textarea[name="observacoes"]').value;

    if (!confirm('Confirma a aplicacao do reajuste de ' + percentual + '% nas parcelas ' + parcelaInicial + ' a ' + parcelaFinal + '?\n\nEsta acao alterara os valores das parcelas pendentes.')) {
        return;
    }

    var btn = document.getElementById('btnAplicarReajuste');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Aplicando...';

    fetch('/financeiro/contrato/{{ contrato.pk }}/reajuste/aplicar/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            indice_tipo: tipoIndice,
            percentual: percentual,
            parcela_inicial: parcelaInicial,
            parcela_final: parcelaFinal,
            observacoes: observacoes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.sucesso) {
            alert(data.mensagem);
            location.reload();
        } else {
            alert('Erro ao aplicar reajuste: ' + data.erro);
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check"></i> Aplicar Reajuste';
        }
    })
    .catch(error => {
        alert('Erro de conexao: ' + error);
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check"></i> Aplicar Reajuste';
    });
});

function excluirReajuste(reajusteId) {
    if (!confirm('Deseja excluir este reajuste?\n\nOs valores das parcelas serao revertidos para os valores anteriores.')) {
        return;
    }

    fetch('/financeiro/reajuste/' + reajusteId + '/excluir/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.sucesso) {
            alert(data.mensagem);
            location.reload();
        } else {
            alert('Erro ao excluir reajuste: ' + data.erro);
        }
    })
    .catch(error => {
        alert('Erro de conexao: ' + error);
    });
}
</script>
{% endblock %}
