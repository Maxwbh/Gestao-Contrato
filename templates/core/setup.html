<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup - Gest√£o de Contratos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }
        .setup-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
        }
        .status-ok {
            background-color: #28a745;
            color: white;
        }
        .status-error {
            background-color: #dc3545;
            color: white;
        }
        .btn-setup {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            border-radius: 10px;
            margin: 0.5rem;
        }
        #output {
            background-color: #2d3748;
            color: #48bb78;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        .spinner {
            display: none;
        }
        h1 {
            color: #667eea;
        }
    </style>
</head>
<body>
    {% csrf_token %}
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="setup-card text-center">
                    <h1>üöÄ Setup do Sistema</h1>
                    <p class="lead">Configura√ß√£o Inicial do Sistema de Gest√£o de Contratos</p>
                    <p class="text-muted">Desenvolvido por Maxwell da Silva Oliveira</p>
                </div>

                <div class="setup-card">
                    <h3>üìä Status do Sistema</h3>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Banco de Dados:</strong>
                                <span class="status-badge {% if db_ok %}status-ok{% else %}status-error{% endif %}">
                                    {% if db_ok %}‚úÖ Conectado{% else %}‚ùå Erro{% endif %}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Tabelas:</strong>
                                <span class="status-badge {% if has_tables %}status-ok{% else %}status-error{% endif %}">
                                    {% if has_tables %}‚úÖ Criadas{% else %}‚ùå N√£o criadas{% endif %}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Superusu√°rio:</strong>
                                <span class="status-badge {% if total_users > 0 %}status-ok{% else %}status-error{% endif %}">
                                    {% if total_users > 0 %}‚úÖ {{ total_users }} usu√°rio(s){% else %}‚ùå Nenhum{% endif %}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Dados de Teste:</strong>
                                <span class="status-badge {% if total_contabilidades > 0 %}status-ok{% else %}status-error{% endif %}">
                                    {% if total_contabilidades > 0 %}‚úÖ {{ total_contabilidades }} contabilidade(s){% else %}‚ùå Vazio{% endif %}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Imobili√°rias:</strong>
                                <span class="status-badge {% if total_imobiliarias > 0 %}status-ok{% else %}status-error{% endif %}">
                                    {% if total_imobiliarias > 0 %}‚úÖ {{ total_imobiliarias }} imobili√°ria(s){% else %}‚ùå Nenhuma{% endif %}
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Contas Banc√°rias:</strong>
                                <span class="status-badge {% if total_contas_bancarias > 0 %}status-ok{% else %}status-error{% endif %}">
                                    {% if total_contas_bancarias > 0 %}‚úÖ {{ total_contas_bancarias }} conta(s){% else %}‚ùå Nenhuma (necess√°rio para boletos){% endif %}
                                </span>
                            </p>
                        </div>
                    </div>
                    {% if total_imobiliarias > 0 and total_contas_bancarias == 0 %}
                    <div class="alert alert-warning mt-3">
                        <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Existem imobili√°rias sem contas banc√°rias configuradas.
                        Para gerar boletos, √© necess√°rio ter pelo menos uma conta banc√°ria principal.
                        <br><strong>Execute "Gerar Dados" com a op√ß√£o "Limpar antes" marcada para recriar os dados com contas banc√°rias.</strong>
                    </div>
                    {% endif %}
                </div>

                <div class="setup-card">
                    <h3>‚öôÔ∏è A√ß√µes de Setup</h3>
                    <hr>

                    <div class="row">
                        <div class="col-md-12 text-center mb-4">
                            <h5>Setup Completo (Recomendado)</h5>
                            <p>Executa migrations, cria superuser e gera dados de teste</p>
                            <button class="btn btn-primary btn-setup btn-lg" onclick="executarSetupCompleto()">
                                üéØ Setup Completo
                            </button>
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="col-md-4 text-center">
                            <h6>Migrations</h6>
                            <button class="btn btn-info btn-setup" onclick="executarAcao('migrations')">
                                üìä Executar Migrations
                            </button>
                        </div>
                        <div class="col-md-4 text-center">
                            <h6>Superusu√°rio</h6>
                            <button class="btn btn-success btn-setup" onclick="executarAcao('superuser')">
                                üë§ Criar Admin
                            </button>
                        </div>
                        <div class="col-md-4 text-center">
                            <h6>Dados de Teste</h6>
                            <button class="btn btn-warning btn-setup" onclick="executarAcao('dados')">
                                üìã Gerar Dados
                            </button>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <div class="spinner spinner-border text-primary" role="status">
                            <span class="visually-hidden">Processando...</span>
                        </div>
                    </div>

                    <div id="output" class="mt-4"></div>
                </div>

                <div class="setup-card">
                    <h3>üì° API de Dados de Teste</h3>
                    <hr>
                    <p>Use o endpoint abaixo para gerar ou consultar dados de teste via API:</p>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-header bg-info text-white">
                                    <strong>GET</strong> /api/gerar-dados-teste/
                                </div>
                                <div class="card-body">
                                    <p class="card-text">Retorna estat√≠sticas dos dados existentes.</p>
                                    <button class="btn btn-sm btn-outline-info" onclick="consultarDados()">
                                        Consultar Dados
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-header bg-success text-white">
                                    <strong>POST</strong> /api/gerar-dados-teste/
                                </div>
                                <div class="card-body">
                                    <p class="card-text">Gera dados de teste (contratos, parcelas, √≠ndices).</p>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="limparDados">
                                        <label class="form-check-label" for="limparDados">
                                            Limpar antes
                                        </label>
                                    </div>
                                    <button class="btn btn-sm btn-success" onclick="gerarDadosAPI()">
                                        Gerar via API
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-header bg-danger text-white">
                                    <strong>DELETE</strong> /api/limpar-dados-teste/
                                </div>
                                <div class="card-body">
                                    <p class="card-text">Excluir Dados de Teste do sistema.</p>
                                    <button class="btn btn-sm btn-danger" onclick="limparDadosAPI()">
                                        Excluir Dados
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="apiOutput" class="mt-3" style="display: none;">
                        <pre style="background: #2d3748; color: #48bb78; padding: 1rem; border-radius: 8px; max-height: 300px; overflow-y: auto;"></pre>
                    </div>
                </div>

                <div class="setup-card text-center">
                    <h5>üìö Pr√≥ximos Passos</h5>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                        <a href="/admin/" class="btn btn-primary">
                            üîê Acessar Admin
                        </a>
                        <a href="/" class="btn btn-success">
                            üè† Ir para Home
                        </a>
                        <button class="btn btn-secondary" onclick="location.reload()">
                            üîÑ Atualizar Status
                        </button>
                    </div>
                    <p class="mt-3 text-muted small">
                        <strong>Credenciais padr√£o:</strong> admin / admin123<br>
                        <strong>IMPORTANTE:</strong> Altere a senha ap√≥s o primeiro login!
                    </p>
                </div>

                <div class="text-center text-white mt-4">
                    <p>Sistema de Gest√£o de Contratos de Venda de Im√≥veis</p>
                    <p>Desenvolvido por <strong>Maxwell da Silva Oliveira</strong></p>
                    <p>M&S do Brasil LTDA | <a href="https://msbrasil.inf.br" class="text-white">msbrasil.inf.br</a></p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Funcao para obter CSRF token do cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        function mostrarSpinner(mostrar) {
            const spinner = document.querySelector('.spinner');
            if (mostrar) {
                spinner.style.display = 'block';
            } else {
                spinner.style.display = 'none';
            }
        }

        function mostrarOutput(mensagens) {
            const output = document.getElementById('output');
            output.style.display = 'block';
            output.innerHTML = mensagens.map(m => `<div>${m}</div>`).join('');
            output.scrollTop = output.scrollHeight;
        }

        function executarSetupCompleto() {
            if (!confirm('Isso executar√° migrations, criar√° superuser e gerar√° dados de teste. Continuar?')) {
                return;
            }

            mostrarSpinner(true);

            const formData = new FormData();
            formData.append('action', 'setup_completo');
            formData.append('gerar_dados', 'true');

            fetch('/setup/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                mostrarSpinner(false);
                if (data.status === 'success') {
                    mostrarOutput(data.messages);
                    setTimeout(() => {
                        alert('‚úÖ Setup completo! Recarregando p√°gina...');
                        location.reload();
                    }, 2000);
                } else {
                    alert('‚ùå Erro: ' + data.message);
                }
            })
            .catch(error => {
                mostrarSpinner(false);
                alert('‚ùå Erro na requisi√ß√£o: ' + error);
            });
        }

        function executarAcao(action) {
            const actions = {
                'migrations': 'Executar Migrations?',
                'superuser': 'Criar Superusu√°rio admin/admin123?',
                'dados': 'Gerar Dados de Teste?'
            };

            if (!confirm(actions[action])) {
                return;
            }

            mostrarSpinner(true);

            const formData = new FormData();
            formData.append('action', action);

            fetch('/setup/', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                mostrarSpinner(false);
                if (data.status === 'success') {
                    mostrarOutput(data.messages);
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    alert('‚ùå Erro: ' + data.message);
                }
            })
            .catch(error => {
                mostrarSpinner(false);
                alert('‚ùå Erro na requisi√ß√£o: ' + error);
            });
        }

        // Fun√ß√µes para API de dados de teste
        function mostrarApiOutput(data) {
            const container = document.getElementById('apiOutput');
            const pre = container.querySelector('pre');
            container.style.display = 'block';
            pre.textContent = JSON.stringify(data, null, 2);
        }

        async function consultarDados() {
            try {
                const response = await fetch('/api/gerar-dados-teste/');
                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    data = { status: 'error', message: 'Resposta inv√°lida do servidor', response_text: text.substring(0, 500), http_status: response.status };
                }
                mostrarApiOutput(data);
            } catch (error) {
                mostrarApiOutput({ error: error.toString() });
            }
        }

        async function gerarDadosAPI() {
            const limpar = document.getElementById('limparDados').checked;

            if (!confirm(limpar
                ? '‚ö†Ô∏è Isso ir√° LIMPAR todos os dados existentes e gerar novos. Continuar?'
                : 'Gerar dados de teste? (dados existentes ser√£o mantidos)')) {
                return;
            }

            mostrarSpinner(true);

            try {
                const response = await fetch('/api/gerar-dados-teste/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify({ limpar: limpar })
                });

                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    data = { status: 'error', message: 'Resposta inv√°lida do servidor', response_text: text.substring(0, 500), http_status: response.status };
                }

                mostrarSpinner(false);
                mostrarApiOutput(data);

                if (data.status === 'success') {
                    alert('‚úÖ Dados gerados com sucesso!');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    alert('‚ùå Erro: ' + (data.message || data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                mostrarSpinner(false);
                mostrarApiOutput({ error: error.toString() });
                alert('‚ùå Erro na requisi√ß√£o: ' + error);
            }
        }

        async function limparDadosAPI() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO: Isso ir√° EXCLUIR PERMANENTEMENTE todos os dados!\n\nContabilidades, Imobili√°rias, Im√≥veis, Compradores, Contratos, Parcelas e √çndices ser√£o removidos.\n\nTem certeza que deseja continuar?')) {
                return;
            }

            if (!confirm('üî¥ √öLTIMA CONFIRMA√á√ÉO: Todos os dados ser√£o perdidos. Confirma a exclus√£o?')) {
                return;
            }

            mostrarSpinner(true);

            try {
                const response = await fetch('/api/limpar-dados-teste/', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken,
                    },
                    body: JSON.stringify({ confirmar: true })
                });

                const text = await response.text();
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    data = { status: 'error', message: 'Resposta inv√°lida do servidor', response_text: text.substring(0, 500), http_status: response.status };
                }

                mostrarSpinner(false);
                mostrarApiOutput(data);

                if (data.status === 'success') {
                    alert('‚úÖ Dados exclu√≠dos com sucesso!');
                    setTimeout(() => location.reload(), 2000);
                } else {
                    alert('‚ùå Erro: ' + (data.message || data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                mostrarSpinner(false);
                mostrarApiOutput({ error: error.toString() });
                alert('‚ùå Erro na requisi√ß√£o: ' + error);
            }
        }
    </script>
</body>
</html>
